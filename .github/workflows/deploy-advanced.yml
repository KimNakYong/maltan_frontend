name: Advanced Deploy to GCP with CDN

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸ” Run tests (optional)
        run: npm run test --if-present
        continue-on-error: true

      - name: ðŸ—ï¸ Build production
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env.production
          echo "VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" >> .env.production
          npm run build

      - name: ðŸ“Š Build size report
        run: |
          echo "### Build Size Report ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh build >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: ðŸš€ Deploy to GCS
        id: deploy
        run: |
          # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # ë¹Œë“œ í™•ì¸
          echo "Checking build output..."
          ls -la build/
          
          # ë°±ì—… ìƒì„± (ì„ íƒì‚¬í•­)
          # gsutil -m cp -r gs://${{ secrets.GCP_BUCKET_NAME }} gs://${{ secrets.GCP_BUCKET_NAME }}-backup-${TIMESTAMP}
          
          # ë°°í¬
          gsutil -m rsync -r -d build/ gs://${{ secrets.GCP_BUCKET_NAME }}/
          
          # ìºì‹œ ì„¤ì •
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/assets/**" || true
          gsutil setmeta -h "Cache-Control:no-cache, no-store, must-revalidate" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/index.html" || true
          
          # URL ì¶œë ¥
          URL="https://storage.googleapis.com/${{ secrets.GCP_BUCKET_NAME }}/index.html"
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "âœ… Deployed successfully!"
          echo "ðŸŒ URL: ${URL}"

      # CDN ìºì‹œ ë¬´íš¨í™” (CDN ì‚¬ìš© ì‹œ ì£¼ì„ í•´ì œ)
      # - name: ðŸ”„ Invalidate CDN cache
      #   if: success()
      #   run: |
      #     gcloud compute url-maps invalidate-cdn-cache maltan-frontend-lb \
      #       --path "/*" \
      #       --async

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­, SLACK_WEBHOOK_URL secret í•„ìš”)
      # - name: ðŸ“¢ Slack notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: |
      #       Deployment ${{ job.status }}!
      #       URL: ${{ steps.deploy.outputs.url }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ“ Deployment summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **URL**: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Bucket**: gs://${{ secrets.GCP_BUCKET_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”€ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY

