name: Deploy Frontend to GCP Cloud Storage

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— push ì‹œ ìë™ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create .env.production
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env.production
          echo "VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" >> .env.production

      # 5. í”„ë¡œë•ì…˜ ë¹Œë“œ
      - name: Build production
        run: npm run build

      # 6. GCP ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 7. GCP CLI ì„¤ì •
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 8. ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ
      - name: Upload to GCS
        run: |
          # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (ì„ íƒì‚¬í•­)
          gsutil -m rm -r gs://${{ secrets.GCP_BUCKET_NAME }}/* || true
          
          # ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
          gsutil -m cp -r dist/* gs://${{ secrets.GCP_BUCKET_NAME }}/
          
          # ìºì‹œ ì„¤ì •
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/**/*.js"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/**/*.css"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/**/*.png"
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/**/*.jpg"
          gsutil -m setmeta -h "Cache-Control:no-cache" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/index.html"

      # 9. CDN ìºì‹œ ë¬´íš¨í™” (CDN ì‚¬ìš© ì‹œ)
      # - name: Invalidate CDN cache
      #   run: |
      #     gcloud compute url-maps invalidate-cdn-cache maltan-frontend-lb \
      #       --path "/*" \
      #       --async

      # 10. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: Deployment successful
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ URL: https://storage.googleapis.com/${{ secrets.GCP_BUCKET_NAME }}/index.html"

