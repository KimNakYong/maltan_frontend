name: Deploy Frontend to GCP Cloud Storage

on:
  push:
    branches:
      - main  # main 브랜치에 push 시 자동 배포
  workflow_dispatch:  # 수동 실행도 가능

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest
    
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Node.js 설정
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. 의존성 설치
      - name: Install dependencies
        run: npm ci

      # 4. 환경 변수 파일 생성
      - name: Create .env.production
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}
          EOF
          
          echo "📄 .env.production created:"
          cat .env.production

      # 5. 프로덕션 빌드
      - name: Build production
        run: |
          echo "🏗️ Starting build..."
          npm run build
          
          echo "✅ Build completed!"
          echo "📦 Build output:"
          ls -lh build/

      # 6. GCP 인증
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 7. GCP CLI 설정
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 8. 버킷에 파일 업로드 (rsync 사용)
      - name: Upload to GCS
        run: |
          # rsync로 동기화 (삭제/추가/수정 자동 처리)
          gsutil -m rsync -r -d build/ gs://${{ secrets.GCP_BUCKET_NAME }}/
          
          # 캐시 설정
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/assets/**" || true
          gsutil setmeta -h "Cache-Control:no-cache, no-store, must-revalidate" \
            "gs://${{ secrets.GCP_BUCKET_NAME }}/index.html" || true
          
          echo "✅ Upload completed!"

      # 9. CDN 캐시 무효화 (CDN 사용 시)
      # - name: Invalidate CDN cache
      #   run: |
      #     gcloud compute url-maps invalidate-cdn-cache maltan-frontend-lb \
      #       --path "/*" \
      #       --async

      # 10. 배포 완료 알림
      - name: Deployment successful
        run: |
          echo "✅ Deployment completed successfully!"
          echo "🌐 URL: https://storage.googleapis.com/${{ secrets.GCP_BUCKET_NAME }}/index.html"
          echo "📦 Bucket: gs://${{ secrets.GCP_BUCKET_NAME }}"

